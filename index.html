<script>
  let maxG = 0;
  let gData = [];
  let timeLabels = [];
  const MAX_POINTS = 80;
  let bgChart;

  const gForceEl = document.getElementById("gForce");
  const maxGEl = document.getElementById("maxG");
  const startBtn = document.getElementById("startBtn");
  const compassDot = document.getElementById("compassDot");

  function resetMaxG() {
    maxG = 0;
    maxGEl.innerText = "0.00 G";
  }

  function initBackgroundChart() {
    const ctx = document.getElementById('bgChart').getContext('2d');
    bgChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: [{
          data: gData,
          borderColor: '#00f2ff',
          backgroundColor: 'transparent',
          borderWidth: 1,
          tension: 0.2,
          pointRadius: 0
        }]
      },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            display: false,
            min: 0,
            max: 10 // âœ… LOCKED scale
          },
          x: {
            display: false
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });
  }

  function startTracking() {
    startBtn.style.display = 'none';

    if (!bgChart) initBackgroundChart();

    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission().then(response => {
        if (response === 'granted') {
          window.addEventListener('devicemotion', handleMotion);
        } else {
          alert("Motion permission denied.");
        }
      }).catch(console.error);
    } else {
      window.addEventListener('devicemotion', handleMotion);
    }
  }

  function handleMotion(event) {
    const acc = event.accelerationIncludingGravity;
    if (!acc) return;

    const { x, y, z } = acc;
    const gForce = Math.sqrt(x * x + y * y + z * z) / 9.80665;
    const roundedG = gForce.toFixed(2);

    gForceEl.innerText = `${roundedG} G`;
    gForceEl.style.transform = `scale(${1 + gForce * 0.02})`;

    if (gForce > maxG) {
      maxG = gForce;
      maxGEl.innerText = `${maxG.toFixed(2)} G`;
    }

    // Update compass dot direction
    const scale = 30;
    const dx = Math.max(-1, Math.min(1, x / 9.8)) * scale;
    const dy = Math.max(-1, Math.min(1, y / 9.8)) * scale;

    compassDot.style.transform = `translate(${dx}px, ${-dy}px)`;

    // Update chart
    const now = new Date();
    const timeLabel = now.toLocaleTimeString().split(' ')[0];

    if (gData.length >= MAX_POINTS) {
      gData.shift();
      timeLabels.shift();
    }

    gData.push(gForce);
    timeLabels.push(timeLabel);
    if (bgChart) bgChart.update();
  }
</script>
